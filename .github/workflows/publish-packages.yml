name: Publish @frontal/design-system

# This workflow publishes @frontal/design-system to GitHub Packages
# 
# All @frontal/* dependencies are bundled into the package during build,
# so users only need to install @frontal/design-system (and React as a peer dependency).

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'packages/design-system/**'
      - '.github/workflows/publish-packages.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to publish (leave empty to use package.json version)'
        required: false
        type: string

jobs:
  publish:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.3

      - name: Install dependencies
        run: bun install

      - name: Build @frontal/design-system and dependencies
        run: |
          # Build all dependencies first, then design-system
          # The ... syntax builds dependencies, but we need to ensure they're built
          bunx turbo build --filter=@frontal/design-system^...
          bunx turbo build --filter=@frontal/design-system

      - name: Configure npm for GitHub Packages
        working-directory: packages/design-system
        run: |
          echo "@frontal:registry=https://npm.pkg.github.com" >> .npmrc
          # npm automatically uses NODE_AUTH_TOKEN for GitHub Packages authentication

      - name: Verify package contents
        working-directory: packages/design-system
        run: |
          echo "Package contents:"
          ls -la dist/ || echo "dist/ directory not found"
          echo ""
          echo "Checking package.json:"
          cat package.json | grep -A 5 '"files"'

      - name: Check if version already exists
        working-directory: packages/design-system
        id: check-version
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          
          # Check if this version already exists
          if npm view @frontal/design-system@$PACKAGE_VERSION --registry=https://npm.pkg.github.com 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "⚠️  Version $PACKAGE_VERSION already exists. Skipping publish."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "✓ Version $PACKAGE_VERSION is new. Will publish."
          fi
        continue-on-error: true

      - name: Publish to GitHub Packages
        if: steps.check-version.outputs.exists != 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            cd packages/design-system
            npm version ${{ github.event.inputs.version }} --no-git-tag-version
          fi
          
          # Publish from a temporary directory to avoid workspace detection
          TEMP_DIR=$(mktemp -d)
          cp packages/design-system/package.json "$TEMP_DIR/"
          cp -r packages/design-system/dist "$TEMP_DIR/"
          cd "$TEMP_DIR"
          
          # Ensure package.json has correct publishConfig and repository
          # GitHub Packages will publish under the organization that owns the repository
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.publishConfig = {
              registry: 'https://npm.pkg.github.com',
              '@frontal:registry': 'https://npm.pkg.github.com'
            };
            // Ensure repository field is set correctly - this links the package to the repo
            pkg.repository = {
              type: 'git',
              url: 'git+https://github.com/frontal-labs/design-system.git',
              directory: 'packages/design-system'
            };
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "
          
          # Configure npm for GitHub Packages
          echo "@frontal:registry=https://npm.pkg.github.com" > .npmrc
          npm config set //npm.pkg.github.com/:_authToken $NODE_AUTH_TOKEN
          
          # Note: GitHub Packages creates packages automatically on first publish
          # The repository field in package.json links the package to the repository
          
          # Publish (skip scripts since package is already built)
          npm publish --registry=https://npm.pkg.github.com --ignore-scripts

      - name: Verify publication
        run: |
          echo "Package published successfully!"
          echo "Package: @frontal/design-system"
          echo "Version: $(cd packages/design-system && node -p "require('./package.json').version")"
          echo ""
          echo "Install with:"
          echo "  npm install @frontal/design-system"
          echo ""
          echo "Make sure to configure .npmrc in your project:"
          echo "  @frontal:registry=https://npm.pkg.github.com"
          echo "  //npm.pkg.github.com/:_authToken=\${GITHUB_TOKEN}"

