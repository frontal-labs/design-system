name: Publish @frontal/design-system

# This workflow publishes @frontal/design-system to GitHub Packages
# 
# All @frontal/* dependencies are bundled into the package during build,
# so users only need to install @frontal/design-system (and React as a peer dependency).

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'packages/design-system/**'
      - '.github/workflows/publish-packages.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to publish (leave empty to use package.json version)'
        required: false
        type: string

jobs:
  publish:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.3

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build @frontal/design-system and dependencies
        run: |
          # Build all dependencies first, then design-system
          # The ... syntax builds dependencies, but we need to ensure they're built
          bunx turbo build --filter=@frontal/design-system^...
          bunx turbo build --filter=@frontal/design-system

      - name: Configure npm for GitHub Packages
        working-directory: packages/design-system
        run: |
          echo "@frontal:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Verify package contents
        working-directory: packages/design-system
        run: |
          echo "Package contents:"
          ls -la dist/ || echo "dist/ directory not found"
          echo ""
          echo "Checking package.json:"
          cat package.json | grep -A 5 '"files"'

      - name: Check if version already exists
        working-directory: packages/design-system
        id: check-version
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          
          # Check if this version already exists
          if npm view @frontal/design-system@$PACKAGE_VERSION --registry=https://npm.pkg.github.com 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "⚠️  Version $PACKAGE_VERSION already exists. Skipping publish."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "✓ Version $PACKAGE_VERSION is new. Will publish."
          fi
        continue-on-error: true

      - name: Publish to GitHub Packages
        if: steps.check-version.outputs.exists != 'true'
        working-directory: packages/design-system
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            npm version ${{ github.event.inputs.version }} --no-git-tag-version
          fi
          npm publish

      - name: Verify publication
        run: |
          echo "Package published successfully!"
          echo "Package: @frontal/design-system"
          echo "Version: $(cd packages/design-system && node -p "require('./package.json').version")"
          echo ""
          echo "Install with:"
          echo "  npm install @frontal/design-system"
          echo ""
          echo "Make sure to configure .npmrc in your project:"
          echo "  @frontal:registry=https://npm.pkg.github.com"
          echo "  //npm.pkg.github.com/:_authToken=\${GITHUB_TOKEN}"

